#!/bin/bash

# Make the whole script fail on errors
set -eou pipefail

export CURRENT_SHA="${TRAVIS_PULL_REQUEST_SHA:-$TRAVIS_COMMIT}"
PREVIOUS_SHA=$(git merge-base origin/master "${CURRENT_SHA}")
export PREVIOUS_SHA

# Allow github base to be overridden. Useful for enterprise installations.
GITHUB_BASE=${GITHUB_BASE:-"https://github.com"}
if [ -z "${TRAVIS_PULL_REQUEST:-}" ]; then
  export CHANGE_URL="${GITHUB_BASE}/${TRAVIS_REPO_SLUG}/commit/${TRAVIS_COMMIT}"
else
  # Construct a URL to the PR so that we can link the happo reports to it
  export CHANGE_URL="${GITHUB_BASE}/${TRAVIS_REPO_SLUG}/pull/${TRAVIS_PULL_REQUEST}"
fi

# Delegate to the canonical script. It will use the env variables we have
# prepared.
happo-ci
